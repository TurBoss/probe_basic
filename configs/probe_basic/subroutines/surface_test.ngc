o<surface_test> sub
  ;(MSG, SURFACE_TEST.NGC)
  M64 P0  (turn off compensation)
  ;T1 M6 (Install probe)
  #<x0> = #3050 ;(debug, x0: [#<x0>])
  #<y0> = #3051 ;(debug, y0: [#<y0>])
  #<xdist> = #3052 ;(debug, length: [#<xdist>])
  #<ydist> = #3053 ;(debug, width: [#<ydist>])
  #<step> = #3054 ;(debug, step: [#<step>])
  #<search_feed> = #3055 ;(debug, search_feed: [#<search_feed>])
  #<latch_feed> = #3056 ;(debug, latch_feed: [#<latch_feed>])
  #<safe_z> = #3057 ;(debug, safe_z: [#<safe_z>])
  #<search_z> = #3058 ;(debug, search_z: [#<search_z>])

  ;(debug, current coord system:[#<_coord_system>])
  ;(debug, current X offset: #5221)

  ;(PROBEOPEN probe-results.txt)

  ;variables intialization
  G0 Z#<safe_z>
  #<y> = #<y0>
  #<x> = #<x0>
  ;loop count calculation
  #<iy> = [FUP[ABS[#<ydist>/#<step>]]+1]
  #<ix> = [FUP[ABS[#<xdist>/#<step>]]+1]
  
  ;determine initial step direction
  o101 if [#<ydist> GT 0]
    #<stepy> = #<step>
  o101 elseif [#<ydist> LT 0]
    #<stepy> = [#<step>*-1]
  o101 endif
  
  o102 if [#<xdist> GT 0]
    #<stepx> = #<step>
  o102 elseif [#<xdist> LT 0]
    #<stepx> = [#<step>*-1]
  o102 endif

  ;probing loop
  o104 repeat [#<iy>]

    o105 repeat [#<ix>]
      G0 X#<x> Y#<y>
      ;G38.2 Z#<search_z> F#<search_feed>
      ;disable probing for testing purposes, just step to search_z on grid points
      G0 Z#<search_z>
      G0 Z#<safe_z>
      #<x> = [#<x>+#<stepx>]
    o105 endrepeat

    #<stepx> = [#<stepx>*-1]
    #<x> = [#<x>+#<stepx>]
    #<y> = [#<y>+#<stepy>]
        
  o104 endrepeat


  ;(PROBECLOSE)
  G0 X0 Y0
o<surface_test> endsub

M2
